name: Update evals dependency

on:
  repository_dispatch:
    types: [evals-updated]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-evals:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a # v4
        with:
          python-version: "3.13"

      - name: Upgrade evals in lockfile
        run: uv lock --upgrade-package evals

      - name: Check for dependency changes
        id: deps_changed
        run: |
          if git diff --quiet -- pyproject.toml uv.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.deps_changed.outputs.changed == 'true'
        run: uv sync --dev

      - name: Validate updated dependencies
        if: steps.deps_changed.outputs.changed == 'true'
        run: |
          uv run ruff check src/
          uv run ruff format --check src/
          uv run pytest tests/ -v

      - name: Create pull request
        if: steps.deps_changed.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/auto-update-evals
          delete-branch: true
          commit-message: "chore(deps): refresh evals dependency"
          title: "chore(deps): automated evals dependency refresh"
          body: |
            This PR was auto-generated by `.github/workflows/update-evals.yml`.

            It updates the `evals` dependency by running:
            - `uv lock --upgrade-package evals`
            - `uv sync --dev`

            Validation run in this workflow:
            - `uv run ruff check src/`
            - `uv run ruff format --check src/`
            - `uv run pytest tests/ -v`

            Refs #23
          labels: |
            dependencies
            automated
          add-paths: |
            pyproject.toml
            uv.lock
